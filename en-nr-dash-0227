' Function to send review notification email
Private Function SendReviewNotificationEmail(wsData As Worksheet, rowIndex As Long, entryId As Long, status As String, comments As String, reviewer As String) As Boolean
    On Error GoTo ErrorHandler
    
    Dim outlookApp As Object
    Dim mailItem As Object
    Dim htmlBody As String
    Dim userResponse As VbMsgBoxResult
    Dim recipientEmail As String
    
    ' Try to use Outlook
    Set outlookApp = GetOutlookApp()
    
    ' Get recipient email - can be configured in a settings sheet or cell
    recipientEmail = GetRecipientEmail()
    
    If Not outlookApp Is Nothing Then
        Set mailItem = outlookApp.CreateItem(0)  ' 0 = olMailItem
        
        With mailItem
            .To = recipientEmail
            .Subject = "Intake Form Review - Entry ID: " & entryId & " - " & status
            
            ' Build HTML body
            htmlBody = BuildReviewEmailHTML(wsData, rowIndex, entryId, status, comments, reviewer)
            .HTMLBody = htmlBody
            
            ' Optional: Add CC to other stakeholders if needed
            ' .CC = "manager@example.com"
            
            ' Ask user for confirmation
            userResponse = MsgBox("Do you want to send this review notification email?" & vbNewLine & _
                                  "To: " & .To & vbNewLine & _
                                  "Subject: " & .Subject, vbYesNo + vbQuestion)
            
            If userResponse = vbYes Then
                .Send
                SendReviewNotificationEmail = True
            Else
                SendReviewNotificationEmail = False
            End If
        End With
        
        Set mailItem = Nothing
    Else
        ' Outlook not available
        MsgBox "Outlook is not available. Please make sure Outlook is installed and running.", vbExclamation
        SendReviewNotificationEmail = False
    End If
    
    Exit Function
    
ErrorHandler:
    Debug.Print "Error in SendReviewNotificationEmail: " & Err.Description
    MsgBox "Error sending review notification email: " & Err.Description & vbNewLine & _
           "Please ensure Outlook is properly configured.", vbExclamation
    SendReviewNotificationEmail = False
End Function

' Function to build review email HTML content
Private Function BuildReviewEmailHTML(wsData As Worksheet, rowIndex As Long, entryId As Long, status As String, comments As String, reviewer As String) As String
    On Error GoTo ErrorHandler
    
    Dim html As String
    Dim i As Integer
    Dim fieldName As String
    Dim fieldValue As String
    Dim statusClass As String
    Dim statusIcon As String
    
    ' Determine status class and icon based on status
    Select Case status
        Case STATUS_APPROVED
            statusClass = "status-approved"
            statusIcon = "✓"
        Case STATUS_REJECTED
            statusClass = "status-rejected"
            statusIcon = "✕"
        Case Else
            statusClass = "status-pending"
            statusIcon = "⟳"
    End Select
    
    html = "<html><head><meta name='viewport' content='width=device-width, initial-scale=1.0'><style>"
    ' Modern, sleek design with advanced CSS
    html = html & "@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');"
    html = html & "body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; max-width: 650px; margin: 0 auto; padding: 0; background-color: #f5f5f5; }"
    html = html & ".email-container { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; margin: 20px; }"
    html = html & ".header-section { margin-bottom: 30px; }"
    html = html & "h1 { color: #1a202c; font-weight: 600; font-size: 24px; margin-top: 0; margin-bottom: 8px; letter-spacing: -0.5px; }"
    html = html & ".subtitle { color: #718096; font-weight: 400; font-size: 16px; margin-bottom: 25px; }"
    html = html & "h2 { color: #2D3748; font-weight: 600; font-size: 18px; margin-top: 30px; margin-bottom: 15px; letter-spacing: -0.3px; }"
    
    ' Stylish ID badge
    html = html & ".entry-id { display: inline-block; background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%); color: white; padding: 10px 16px; border-radius: 6px; font-weight: 500; letter-spacing: 0.5px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(71, 118, 230, 0.2); }"
    
    ' Status badges
    html = html & ".status-badge { display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 30px; font-size: 14px; font-weight: 500; }"
    html = html & ".status-icon { margin-right: 8px; }"
    html = html & ".status-approved { background-color: #C6F6D5; color: #22543D; }"
    html = html & ".status-rejected { background-color: #FED7D7; color: #822727; }"
    html = html & ".status-pending { background-color: #FEFCBF; color: #744210; }"
    
    ' Review cards
    html = html & ".review-cards { display: flex; gap: 20px; margin: 25px 0; }"
    html = html & ".review-card { flex: 1; background-color: #F7FAFC; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }"
    html = html & ".review-card h3 { color: #2D3748; font-size: 16px; font-weight: 600; margin-top: 0; margin-bottom: 16px; }"
    html = html & ".review-detail { margin-bottom: 12px; }"
    html = html & ".review-label { color: #718096; font-size: 14px; display: block; margin-bottom: 4px; }"
    html = html & ".review-value { color: #4A5568; font-weight: 500; }"
    html = html & ".review-comments { background-color: white; border-radius: 6px; padding: 16px; border-left: 3px solid #4776E6; margin-top: 16px; }"
    
    ' Modern table design
    html = html & "table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 25px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }"
    html = html & "th { background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%); color: white; font-weight: 500; text-align: left; padding: 16px; font-size: 14px; letter-spacing: 0.5px; }"
    html = html & "td { padding: 16px; border-bottom: 1px solid #E2E8F0; font-size: 15px; }"
    html = html & "tr:last-child td { border-bottom: none; }"
    html = html & "tr:nth-child(even) { background-color: #F7FAFC; }"
    html = html & ".category-cell { color: #2D3748; font-weight: 500; }"
    
    ' Button styling
    html = html & ".button-container { text-align: center; margin-top: 30px; }"
    html = html & ".button { display: inline-block; background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(71, 118, 230, 0.2); }"
    html = html & ".button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(71, 118, 230, 0.3); }"
    
    ' Footer styling
    html = html & ".footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #E2E8F0; color: #718096; font-size: 14px; text-align: center; }"
    html = html & "</style></head><body>"
    
    html = html & "<div class='email-container'>"
    html = html & "<div class='header-section'>"
    html = html & "<h1>Intake Form Review Complete</h1>"
    html = html & "<p class='subtitle'>The following submission has been reviewed and a decision has been made.</p>"
    html = html & "<div class='entry-id'>Entry ID: " & entryId & "</div>"
    html = html & "</div>"
    
    ' Status badge - make it prominent
    html = html & "<div style='text-align:center; margin-bottom: 30px;'>"
    html = html & "<span class='status-badge " & statusClass & "'><span class='status-icon'>" & statusIcon & "</span> " & status & "</span>"
    html = html & "</div>"
    
    ' Review cards in a flex layout
    html = html & "<div class='review-cards'>"
    
    ' Review details card
    html = html & "<div class='review-card'>"
    html = html & "<h3>Review Details</h3>"
    html = html & "<div class='review-detail'>"
    html = html & "<span class='review-label'>Reviewer</span>"
    html = html & "<span class='review-value'>" & reviewer & "</span>"
    html = html & "</div>"
    html = html & "<div class='review-detail'>"
    html = html & "<span class='review-label'>Review Date</span>"
    html = html & "<span class='review-value'>" & Format(wsData.Cells(rowIndex, 44).Value, "yyyy-mm-dd") & "</span>"
    html = html & "</div>"
    html = html & "</div>"
    
    ' Comments card
    html = html & "<div class='review-card'>"
    html = html & "<h3>Review Comments</h3>"
    If comments <> "" Then
        html = html & "<div class='review-comments'>" & comments & "</div>"
    Else
        html = html & "<p style='color: #718096;'>No additional comments provided.</p>"
    End If
    html = html & "</div>"
    html = html & "</div>"
    
    ' Submission details
    html = html & "<h2>Submission Details</h2>"
    html = html & "<table>"
    html = html & "<tr><th>Category</th><th>Details</th><th>Status</th></tr>"
    
    ' Loop through form data (columns 1 to 40 in data sheet)
    For i = 1 To 40
        If Not IsEmpty(wsData.Cells(1, i)) And Not IsEmpty(wsData.Cells(rowIndex, i)) Then
            fieldName = wsData.Cells(1, i).Value
            fieldValue = wsData.Cells(rowIndex, i).Value
            
            ' Escape HTML special characters
            fieldName = Replace(Replace(Replace(fieldName, "&", "&amp;"), "<", "&lt;"), ">", "&gt;")
            If IsDate(fieldValue) Then
                fieldValue = Format(fieldValue, "yyyy-mm-dd")
            Else
                fieldValue = Replace(Replace(Replace(CStr(fieldValue), "&", "&amp;"), "<", "&lt;"), ">", "&gt;")
            End If
            
            html = html & "<tr>"
            html = html & "<td class='category-cell'>" & fieldName & "</td>"
            html = html & "<td>" & fieldValue & "</td>"
            html = html & "<td><span class='status-badge " & statusClass & "' style='padding: 4px 8px; font-size: 12px;'>" & status & "</span></td>"
            html = html & "</tr>"
        End If
    Next i
    
    html = html & "</table>"
    
    html = html & "<div class='button-container'>"
    html = html & "<a href='#' class='button'>View in System</a>"
    html = html & "</div>"
    
    html = html & "<div class='footer'>"
    html = html & "Thank you for using our intake form system. If you have any questions, please contact support."
    html = html & "</div>"
    
    html = html & "</div></body></html>"
    
    BuildReviewEmailHTML = html
    
    Exit Function
    
ErrorHandler:
    MsgBox "Error in BuildReviewEmailHTML: " & Err.Description, vbCritical
    BuildReviewEmailHTML = ""
End Function
