Option Explicit

Private Const INPUT_SHEET_NAME As String = "IntakeForm"
Private Const DATA_SHEET_NAME As String = "IntakeData"

Public Sub SubmitIntake()
    On Error GoTo ErrHandler
    Application.ScreenUpdating = False
    
    Dim wsInput As Worksheet, wsData As Worksheet
    Set wsInput = ThisWorkbook.Worksheets(INPUT_SHEET_NAME)
    Set wsData = ThisWorkbook.Worksheets(DATA_SHEET_NAME)
    
    ' Validate form
    If Not ValidateForm(wsInput) Then
        MsgBox "Please fill in all required fields", vbExclamation
        GoTo CleanExit
    End If
    
    ' Get next ID
    Dim entryId As Long
    entryId = GetNextEntryId(wsData)
    
    ' Send email first
    If Not SendEmail(wsInput, entryId) Then GoTo CleanExit
    
    ' If email sent successfully, accumulate data
    SaveFormData wsInput, wsData, entryId
    
    ' Clear form after successful save
    ClearForm wsInput
    
    ' Format the data sheet
    FormatDataSheet wsData
    
    MsgBox "Entry #" & entryId & " has been processed successfully", vbInformation
    
CleanExit:
    Application.ScreenUpdating = True
    Exit Sub
    
ErrHandler:
    MsgBox "Error: " & Err.Description, vbCritical
    Resume CleanExit
End Sub

Private Sub SaveFormData(wsInput As Worksheet, wsData As Worksheet, entryId As Long)
    ' Setup headers if needed
    If wsData.Range("A1").Value = "" Then
        With wsData.Range("A1:H1")
            .Value = Array("Entry ID", "Name", "Email", "Phone", "Company", "Title", "Department", "Timestamp")
            .Font.Bold = True
            .Interior.Color = RGB(240, 240, 240)
        End With
    End If
    
    ' Find next row
    Dim nextRow As Long
    nextRow = wsData.Range("A" & wsData.Rows.Count).End(xlUp).Row + 1
    
    ' Add new data
    With wsData
        .Cells(nextRow, 1).Value = entryId
        .Cells(nextRow, 2).Value = wsInput.Range("B2").Value
        .Cells(nextRow, 3).Value = wsInput.Range("B3").Value
        .Cells(nextRow, 4).Value = wsInput.Range("B4").Value
        .Cells(nextRow, 5).Value = wsInput.Range("B5").Value
        .Cells(nextRow, 6).Value = wsInput.Range("B6").Value
        .Cells(nextRow, 7).Value = wsInput.Range("B7").Value
        .Cells(nextRow, 8).Value = Now
        
        ' Format the new row
        With .Range(.Cells(nextRow, 1), .Cells(nextRow, 8))
            .Borders(xlEdgeBottom).LineStyle = xlContinuous
            .Borders(xlEdgeBottom).Color = RGB(230, 230, 230)
        End With
        
        ' Format specific columns
        .Cells(nextRow, 1).HorizontalAlignment = xlCenter
        .Cells(nextRow, 8).NumberFormat = "yyyy-mm-dd hh:mm:ss"
    End With
End Sub

Private Sub FormatDataSheet(wsData As Worksheet)
    With wsData
        ' Format the used range
        Dim usedRng As Range
        Set usedRng = .UsedRange
        
        ' AutoFit columns
        usedRng.EntireColumn.AutoFit
        
        ' Set consistent font
        With usedRng.Font
            .Name = "Calibri"
            .Size = 11
        End With
        
        ' Format headers
        With .Range("A1:H1")
            .Font.Bold = True
            .Interior.Color = RGB(240, 240, 240)
            .Borders(xlBottom).LineStyle = xlContinuous
            .Borders(xlBottom).Weight = xlMedium
            .Borders(xlBottom).Color = RGB(180, 180, 180)
        End With
        
        ' Alternate row colors
        Dim i As Long
        For i = 2 To usedRng.Rows.Count
            If i Mod 2 = 0 Then
                .Range("A" & i & ":H" & i).Interior.Color = RGB(252, 252, 252)
            End If
        Next i
        
        ' Add freeze panes
        .Range("A2").Select
        ActiveWindow.FreezePanes = True
        
        ' Set column widths if needed
        .Columns("A").ColumnWidth = 8  ' Entry ID
        .Columns("H").ColumnWidth = 18 ' Timestamp
        
        ' Format Entry ID column
        .Range("A2:A" & usedRng.Rows.Count).HorizontalAlignment = xlCenter
        
        ' Format Timestamp column
        .Range("H2:H" & usedRng.Rows.Count).NumberFormat = "yyyy-mm-dd hh:mm:ss"
        
        ' Remove gridlines (optional)
        ActiveWindow.DisplayGridlines = False
        
        ' Select first cell
        .Range("A1").Select
    End With
End Sub

Private Function ValidateForm(ws As Worksheet) As Boolean
    Dim cell As Range
    For Each cell In ws.Range("B2:B7")
        If Len(Trim(cell.Value)) = 0 Then
            cell.Select
            Exit Function
        End If
    Next cell
    ValidateForm = True
End Function

Private Sub ClearForm(ws As Worksheet)
    With ws
        .Range("B2:B7").ClearContents
        .Range("B2").Select
    End With
End Sub

Private Function GetNextEntryId(wsData As Worksheet) As Long
    Dim lastRow As Long
    lastRow = wsData.Range("A" & wsData.Rows.Count).End(xlUp).Row
    GetNextEntryId = IIf(lastRow = 1, 1, wsData.Cells(lastRow, 1).Value + 1)
End Function
