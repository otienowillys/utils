Option Explicit

'-------------------------------------------------------------------
' Module-level Constants
'-------------------------------------------------------------------
Private Const INPUT_SHEET_NAME As String = "IntakeForm"
Private Const DATA_SHEET_NAME As String = "IntakeData"

'==============================================
' Main Sub: SubmitIntake
'==============================================
Public Sub SubmitIntake()
    On Error GoTo ErrHandler

    ' Disable screen updating & auto-calculation for performance
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Dim wsInput As Worksheet, wsData As Worksheet
    Set wsInput = ThisWorkbook.Sheets(INPUT_SHEET_NAME)
    Set wsData = ThisWorkbook.Sheets(DATA_SHEET_NAME)

    ' Validate required fields
    If Not ValidateForm(wsInput) Then
        MsgBox "Please fill in all required fields.", vbExclamation, "Missing Information"
        wsInput.Activate
        GoTo CleanExit
    End If

    ' Determine next available Entry ID
    Dim entryId As Long
    entryId = GetNextEntryId(wsData)

    ' Display the email and ask for confirmation before sending
    If SendEmail(wsInput, entryId) Then
        ' Save to IntakeData
        SaveFormData wsInput, wsData, entryId
        ' Clear IntakeForm fields
        ClearForm wsInput
        ' Format the data sheet
        FormatDataSheet wsData

        MsgBox "Entry #" & entryId & " has been processed successfully!", vbInformation, "Submission Successful"
        wsInput.Activate
        wsInput.Range("B2").Select
    Else
        MsgBox "Email was not sent. Data was not saved.", vbExclamation, "Process Canceled"
    End If

CleanExit:
    ' Restore application settings
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

ErrHandler:
    MsgBox "Error: " & Err.Description & " (Error No: " & Err.Number & ")", vbCritical, "Unexpected Error"
    Resume CleanExit
End Sub

'==============================================
' Function: ValidateForm
' Checks that required fields in IntakeForm are not empty.
'==============================================
Private Function ValidateForm(ws As Worksheet) As Boolean
    Dim cell As Range
    For Each cell In ws.Range("B2:B7")
        If Len(Trim(cell.Value)) = 0 Then
            cell.Select
            ValidateForm = False
            Exit Function
        End If
    Next cell
    ValidateForm = True
End Function

'==============================================
' Function: GetNextEntryId
' Returns the next available Entry ID from IntakeData.
'==============================================
Private Function GetNextEntryId(wsData As Worksheet) As Long
    Dim lastRow As Long
    lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
    GetNextEntryId = IIf(lastRow < 2, 1, wsData.Cells(lastRow, "A").Value + 1)
End Function

'==============================================
' Function: SendEmail
' Prepares an email and asks the user for confirmation before sending.
'==============================================
Private Function SendEmail(wsInput As Worksheet, entryId As Long) As Boolean
    On Error GoTo EmailError

    Dim outApp As Object, outMail As Object
    Set outApp = CreateObject("Outlook.Application")
    Set outMail = outApp.CreateItem(0)

    ' Prepare email content
    With outMail
        .To = wsInput.Range("B3").Value   ' Recipient email
        .Subject = "Form Submission #" & entryId
        .HTMLBody = BuildEmailHTML(wsInput, entryId)
        .Display  ' Show email for review
    End With

    ' Confirm before sending
    Dim userResponse As VbMsgBoxResult
    userResponse = MsgBox("Do you want to send this email now?", vbQuestion + vbYesNo, "Confirm Email Send")

    If userResponse = vbYes Then
        ' Try to send the email
        On Error Resume Next
        outMail.Send
        If Err.Number = 0 Then
            SendEmail = True   ' Mark as successfully sent
        Else
            MsgBox "Failed to send email: " & Err.Description, vbExclamation, "Email Error"
            SendEmail = False
        End If
        On Error GoTo 0
    Else
        MsgBox "Email was not sent. No data was saved.", vbInformation, "Action Canceled"
        SendEmail = False
    End If

    ' Ensure objects are properly released
    Set outMail = Nothing
    Set outApp = Nothing
    Exit Function

EmailError:
    MsgBox "Email error: " & Err.Description & " (Error No: " & Err.Number & ")", vbExclamation, "Email Issue"
    Set outMail = Nothing
    Set outApp = Nothing
    Resume Next
End Function

'==============================================
' Sub: SaveFormData
' Saves the form data into IntakeData after email is sent.
'==============================================
Private Sub SaveFormData(wsInput As Worksheet, wsData As Worksheet, entryId As Long)
    Dim nextRow As Long
    nextRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row + 1

    wsData.Cells(nextRow, 1).Value = entryId
    wsData.Cells(nextRow, 2).Resize(1, 6).Value = wsInput.Range("B2:B7").Value
    wsData.Cells(nextRow, 8).Value = Now
    wsData.Cells(nextRow, 8).NumberFormat = "yyyy-mm-dd hh:mm:ss"
End Sub

'==============================================
' Sub: FormatDataSheet
' Formats the IntakeData sheet for better readability.
'==============================================
Private Sub FormatDataSheet(wsData As Worksheet)
    With wsData
        .UsedRange.EntireColumn.AutoFit
        .Columns("A:H").HorizontalAlignment = xlLeft
        .Range("A1:H1").Font.Bold = True
        .Range("A1:H1").Interior.Color = RGB(240, 240, 240)

        ' Add borders to the table
        Dim lastRow As Long
        lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
        If lastRow > 1 Then
            With .Range("A1:H" & lastRow).Borders
                .LineStyle = xlContinuous
                .Weight = xlThin
            End With
        End If
    End With
End Sub

'==============================================
' Sub: ClearForm
' Clears the IntakeForm fields after data is saved.
'==============================================
Private Sub ClearForm(ws As Worksheet)
    ws.Range("B2:B7").ClearContents
    ws.Range("B2").Select
End Sub
